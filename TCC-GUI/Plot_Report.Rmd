---
title: "TCC-GUI Analysis Report"
output: html_document
params:
  CountData: NA
  groupList: NA
  result: NA
  norData: NA
  zeroValue: NA
  sampleDistributionBar: NA
  sampleDistributionDensity: NA
  norSampleDistributionBar: NA
  norSampleDistributionDensity: NA
  MAPlotObject: NA
  VolcanoPlotObject: NA
  pcaParameter: NULL
  screePlot: NULL
  pca3d: NULL
  pca2d: NULL
  summaryPCA: NULL
  heatmapObject: NA
  
  expressionLevelBar: NULL
  expressionLevelBox: NULL
  
  groupListConvert: NA
  filterLowCount: NA
  normMethod: NA
  testMethod: NA
  iteration: NA
  fdr: NA
  floorpdeg: NA
  
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, results='asis')
library(plotly)
library(knitr)
library(DT)
```

If "Not available" is shown in the report, it means:  
1. You seleted not to show this part in ouput option.  
2. You haven't generate the plot in TCC-GUI. Only the plot was shown in TCC-GUI at least one time, it can be output to the report.  

# Session infomation

This report is generated at: 
`r Sys.time()`  

Size of original dataset:   
`r nrow(params$CountData)` rows  
`r ncol(params$CountData)` columns

Number of group: 
`r length(params$groupList)`  
Detail of group information (Used columns):  
```{r groupList}
for(i in 1:length(params$groupList)){
  group_name <- names(params$groupList)[i]
  cat(paste0(group_name, ": ",
             paste0(params$groupList[[i]], collapse = ", "), 
             "  \n")
      )
}
```

Number of gene which expression level equal to zero in all sample: 
`r params$zeroValue`  

# 2. TCC Computation

This part is about TCC Computation processing.  
TCC Parameters is shown as below. 
```{r tcc parameters}
tccPara <- rbind(
  c("params$CountData", "Count data", class(params$CountData)),
  c("params$groupListConvert", "List of group infomation", class(params$groupListConvert)),
  c("params$filterLowCount", "Filter low count genes threshold", params$filterLowCount),
  c("params$normMethod", "Normalization method", params$normMethod),
  c("params$testMethod", "DEGs identify method", params$testMethod),
  c("params$iteration", "Iteration", params$iteration),
  c("params$fdr", "FDR", params$fdr),
  c("params$floorpdeg", "Elimination of potential DEGs", params$floorpdeg)
  )
colnames(tccPara) <- c("Parameters", "Explanation", "Value / class")
kable(tccPara, caption = "Paramters used in TCC computation.")
```

```{r show count data}
kable(head(params$CountData, 10), caption = "First 10 row of original dataset.")
```

List of group infomation is shown as below:  
```{r groupListConvert, results='markup'}
params$groupListConvert
```

Computation code is shown as below.  

(If you want to run this piece of code directly, loading data into your own R environment is necessary. Using `data <- data.table::fread(YOUR_FILE_PATH)` to replace `data <- params$CountData` is a highly efficiency way of reading row count text file. Next create a variable `data.cl` to save group information list.)  
```{r tcc computation, echo=TRUE, eval=FALSE}
library(TCC)
# Dataset
data <- params$CountData
# Group infomation
data.cl <- params$groupListConvert

# Create TCC Object
tcc <- new("TCC", data[data.cl != 0], data.cl[data.cl != 0])
# Filter low count genes before calculation
tcc <- filterLowCountGenes(tcc, low.count = params$filterLowCount)
# Run TCC and calculate normalized factor
tcc <- calcNormFactors(tcc, 
                       norm.method = params$normMethod,
                       test.method = params$testMethod,
                       iteration = params$iteration,
                       FDR = params$fdr,
                       floorPDEG = params$floorpdeg)

# Estimate DEGs
tcc <- estimateDE(tcc,
                  test.method = input$testMethod,
                  FDR = input$fdr)

# Get final result of TCC
result <- getResult(tcc, sort = FALSE)
norData <- tcc$getNormalizedData()
```

Here is a preview of your TCC results.  
```{r tcc result}
kable(head(params$result, 10), caption = "First 10 row of TCC result table")
kable(head(params$norData, 10), caption = "First 10 row of normalized data")
```


## 3. MA Plot  
```{r}
if(params$MAPlotObject != ""){
  params$MAPlotObject
} else {
  "Not available"
}
```

## 4. Volcano Plot  
```{r}
if(params$VolcanoPlotObject != ""){
  params$VolcanoPlotObject
} else {
  "Not available"
}
```

## 5. Principal Components Analysis  

PCA parameters is shown as below:

```{r pca para}
if(params$pcaParameter$pcData == 'o'){
  data <- "Raw Count Data"
}else{
  data <- "Normalized Data"
}

pcaPara <- rbind(
  c("pcaData", "Data source", data),
  c("pcaFDR", "FDR Cut-off", params$pcaParameter$pcFDR),
  c("pcaTransform", "Log(x+1) transform", params$pcaParameter$pcTransform),
  c("pcaCenter", "Center", params$pcaParameter$pcCenter),
  c("pcaScale", "Scale", params$pcaParameter$pcScale)
  )
  colnames(pcaPara) <-
  c("Parameter", "Explanation", "Value")
  kable(pcaPara, caption = "Paramters used in PCA.")
```


```{r pca computation}
if(length(params$pcaParameter) > 0){
cat("Computation code is shown as below. This part should be after the TCC Computation.\n")
cat("```r\n")
cat("# Obtain dataset from TCC Object\n")
if (params$pcaParameter$pcData == "o") {
  cat("data <- tcc$count\n")
} else {
  cat("data <- getNormalizedData(tcc)\n")
}

result <- getResult(tcc)

# Select DEGs (Row)
if (params$testMethod != 'wad') {
  cat("\n# Select genes by q.value (FDR)\n")
  cat("result <- getResult(tcc)\n")
  cat(paste0("data <- data[result$q.value <= ", params$pcaParameter$pcFDR, ", ]\n"))
} 

# PCA processing
if (params$pcaParameter$pcTransform == TRUE) {
  cat("\n# Log transform dataset\n")
  cat("data <- t(log1p(data))\n")
} else {
  cat("data <- t(data)\n")
}
cat("\n# Execute PCA")
cat(paste0("data.pca <- prcomp(data[, apply(data, 2, var) != 0], center = ", params$pcaParameter$pcCenter,", scale. = ", params$pcaParameter$pcScale, "\n"))
cat("```\n")
} else {
  cat("")
}
```

### 5.1 Summary Table of PCA
```{r}
if(length(params$summaryPCA) > 0){
  params$summaryPCA
} else {
  "Not available"
}
```

### 5.2 Scree plot  
```{r}
if(length(params$screePlot) > 0){
  params$screePlot
} else {
  "Not available"
}
```

### 5.3 3D  
```{r}
if(length(params$pca3d) > 0){
  params$pca3d
} else {
  "Not available"
}
```

### 5.4 2D  
```{r}
if(length(params$pca2d) > 0){
  params$pca2d
} else {
  "Not available"
}
```

## 6. Heatmap  
```{r}
if(params$heatmapObject != ""){
  params$heatmapObject
} else {
  "Not available"
}
```

## 7. Expression Level  

### Selected Genes
```{r}
if(length(params$expressionLevelBar) > 0){
  params$expressionLevelBar
} else {
  "Not available"
}
```

### Barplot  
```{r}
if(length(params$expressionLevelBar) > 0){
  params$expressionLevelBar
} else {
  "Not available"
}
```

### Boxplot  
```{r}
if(length(params$expressionLevelBox) > 0){
  params$expressionLevelBox
} else {
  "Not available"
}
```
